<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Fernando Lhamas">

<title>Aula 09 - PSM</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="Aula09_files/libs/clipboard/clipboard.min.js"></script>
<script src="Aula09_files/libs/quarto-html/quarto.js"></script>
<script src="Aula09_files/libs/quarto-html/popper.min.js"></script>
<script src="Aula09_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Aula09_files/libs/quarto-html/anchor.min.js"></script>
<link href="Aula09_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Aula09_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Aula09_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Aula09_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Aula09_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Aula 09 - PSM</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Fernando Lhamas </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="propensity-score-matching" class="level2">
<h2 class="anchored" data-anchor-id="propensity-score-matching">Propensity Score Matching</h2>
<p>A partir de um design observacional, podemos realizar uma técnica de pareamento estatístico, que busca estimar o efeito de um tratamento, política ou intervenção, levando em consideração possíveis <strong>covariáveis</strong> que podem afetar o tratamento.</p>
<p>Rosenbaum e Rubin introduziram está técnica em 1983, atribuindo uma probabilidade condicional de cada observação fazer parte do tratamento. Esta probabilidade de fazer parte do tratamento, é baseada nos scores das covariáveis.</p>
<p>Foi percebido então, que ao adotar este método antes de efetivamente estimar os efeitos de um tratamento em uma população em um estudo observacional, podemos reduzir as ameaças à validade interna, provocadas principalmente pela não randomização, ou seja, por não ter um <strong>design experimental.</strong></p>
<p>O matching nada mais é do que a criação de um grupo de controle artificial, com probabilidades pareadas entre os grupos par a par (tratamento e controle).</p>
<p>O <strong>score de propensão</strong> indica o quão apto ou propenso, a observação está para receber o tratamento. Esse score é formado justamente pelas covariáveis (características que influenciam a variável de tratamento).</p>
</section>
<section id="vantagens-e-desvantagens" class="level2">
<h2 class="anchored" data-anchor-id="vantagens-e-desvantagens">Vantagens e desvantagens</h2>
<ul>
<li><p>O PSM consegue reduzir substancialmente o viés de seleção em estudos observacionais</p></li>
<li><p>Não podemos dizer que o design observacional foi alterado para um experimento natural, simplesmente por adotar o PSM na análise. O PSM altera o design, se aproximando de um design quasi-experimental.</p></li>
<li><p>Apesar do evento ou tratamento ser natural, O PSM é deliberadamente aplicado pelo pesquisador para equilibrar os grupos e fortalecer as inferências causais.</p></li>
<li><p>O PSM não considera variáveis latentes como covariáveis. Isso quer dizer que, qualquer efeito não observável que esteja confundindo as relações entre as variáveis de interesse, não são aplicáveis no PSM.</p></li>
<li><p>As alternativas para o caso anterior, incluem modelagem de equações estruturais, análise multinível e outras técnicas de quasi-experimento que lidam com variáveis latentes (variáveis instrumentais e regressão discontínua, por exemplo).</p></li>
<li><p>O próprio PSM, com algumas inovações no algoritmo, permite trabalhar com variáveis latentes. Normalmente, as técnicas quasi-experimentais tem recebido atenção dos pesquisadores para gerar versões com sufixo latente.</p></li>
</ul>
</section>
<section id="exemplo-completo" class="level2">
<h2 class="anchored" data-anchor-id="exemplo-completo">Exemplo completo</h2>
<p>Vamos analisar os dados de crianças (ecls.csv) sobre o efeito de ir em uma escola católica oposta a uma escola pública, para verificar o desempenho em matemática.</p>
<p>Os dados podem ser obtidos aqui</p>
<p>&lt;<a href="https://github.com/sejdemyr/ecls/tree/master" class="uri">https://github.com/sejdemyr/ecls/tree/master</a>&gt;</p>
<p>O estudo pode ser conferido aqui, assim como o codebook</p>
<p>&lt;<a href="https://www.childandfamilydataarchive.org/cfda/archives/cfda/studies/4075" class="uri">https://www.childandfamilydataarchive.org/cfda/archives/cfda/studies/4075</a>&gt;</p>
<p>Vamos seguir o passo-a-passo do PSM para realizar a análise.</p>
<p>Vamos iniciar carregando os pacotes e importando a base:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MatchIt) <span class="co"># para o PSM</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.2     ✔ readr     2.1.4
✔ forcats   1.0.0     ✔ stringr   1.5.0
✔ ggplot2   3.4.2     ✔ tibble    3.2.1
✔ lubridate 1.9.2     ✔ tidyr     1.3.0
✔ purrr     1.0.1     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>ecls <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"ecls.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="explorando-os-dados" class="level2">
<h2 class="anchored" data-anchor-id="explorando-os-dados">Explorando os dados</h2>
<p>Vamos começar gerando algumas saídas referentes a diferença de médias dos grupos na variável resposta.</p>
<p>A variável resposta é a nota estandardizada de matemática (‘c5r2mtsc_std’), e a variável de tratamento é dicotômica (‘catholic’).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>ecls <span class="sc">%&gt;%</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(catholic) <span class="sc">%&gt;%</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n_students =</span> <span class="fu">n</span>(),</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">mean_math =</span> <span class="fu">mean</span>(c5r2mtsc_std),</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">std_error =</span> <span class="fu">sd</span>(c5r2mtsc_std)<span class="sc">/</span><span class="fu">sqrt</span>(n_students))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 4
  catholic n_students mean_math std_error
     &lt;int&gt;      &lt;int&gt;     &lt;dbl&gt;     &lt;dbl&gt;
1        0       9568   -0.0306    0.0104
2        1       1510    0.194     0.0224</code></pre>
</div>
</div>
<p>Percebemos que estudantes das escolas católicas tiveram nota de matemática maior do que os de escola pública (em 20% a mais, considerando o desvio padronizado).</p>
<p>Vamos ver o resultados sem valores padronizados</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>ecls <span class="sc">%&gt;%</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(catholic) <span class="sc">%&gt;%</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n_students =</span> <span class="fu">n</span>(),</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">mean_math =</span> <span class="fu">mean</span>(c5r2mtsc),</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">std_error =</span> <span class="fu">sd</span>(c5r2mtsc)<span class="sc">/</span><span class="fu">sqrt</span>(n_students))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 4
  catholic n_students mean_math std_error
     &lt;int&gt;      &lt;int&gt;     &lt;dbl&gt;     &lt;dbl&gt;
1        0       9568      50.2     0.101
2        1       1510      52.4     0.217</code></pre>
</div>
</div>
<p>Aparentemente as notas estão na mesma escala, então podemos conduzir um teste de comparação de médias sem os valores padronizados. Mas antes, vamos ver como a nota bruta foi padronizada. Para não alterar a base original, coloquei em um novo objeto <code>ecls2</code>, a variável <code>mat_stand</code>, que é a mesma de <code>c5r2mtsc_std</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>ecls2 <span class="ot">&lt;-</span> ecls <span class="sc">%&gt;%</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mat_stand =</span> (c5r2mtsc <span class="sc">-</span> <span class="fu">mean</span>(c5r2mtsc)) <span class="sc">/</span> <span class="fu">sd</span>(c5r2mtsc))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Agora conduzindo o teste, vamos utilizar o teste t de amostras independentes, já que temos dois grupos independentes na variável de tratamento.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">t.test</span>(c5r2mtsc_std <span class="sc">~</span> catholic, <span class="at">data=</span>ecls)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Welch Two Sample t-test

data:  c5r2mtsc_std by catholic
t = -9.1069, df = 2214.5, p-value &lt; 2.2e-16
alternative hypothesis: true difference in means between group 0 and group 1 is not equal to 0
95 percent confidence interval:
 -0.2727988 -0.1761292
sample estimates:
mean in group 0 mean in group 1 
    -0.03059583      0.19386817 </code></pre>
</div>
</div>
<p>Obtivemos uma diferença significativa, com p &lt; 0,05 e t = -9,10. Assim, evidenciamos a hipótese alternativa, rejeitando a hipótese nula de que as médias de matemática entre os grupos são iguais.</p>
</section>
<section id="avaliando-as-covariáveis-utilizadas" class="level2">
<h2 class="anchored" data-anchor-id="avaliando-as-covariáveis-utilizadas">Avaliando as covariáveis utilizadas</h2>
<ul>
<li><code>race_white</code>: Dummy se o estudante é branco (1) ou não (0)</li>
<li><code>p5hmage</code>: Idade da mãe</li>
<li><code>w3income</code>: Renda familiar</li>
<li><code>p5numpla</code>: Número de lugares em que o estudante morou nos últimos 4 meses</li>
<li><code>w3momed_hsb</code>: Se a mãe tem ensino médio completo ou abaixo (1) ou ensino superior (0)?</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>ecls_cov <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'race_white'</span>, <span class="st">'p5hmage'</span>, <span class="st">'w3income'</span>, <span class="st">'p5numpla'</span>, <span class="st">'w3momed_hsb'</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>ecls <span class="sc">%&gt;%</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(catholic) <span class="sc">%&gt;%</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">one_of</span>(ecls_cov)) <span class="sc">%&gt;%</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise_all</span>(<span class="fu">funs</span>(<span class="fu">mean</span>(., <span class="at">na.rm =</span> T)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `catholic`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: `funs()` was deprecated in dplyr 0.8.0.
ℹ Please use a list of either functions or lambdas:

# Simple named list: list(mean = mean, median = median)

# Auto named with `tibble::lst()`: tibble::lst(mean, median)

# Using lambdas list(~ mean(., trim = .2), ~ median(., na.rm = TRUE))</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 6
  catholic race_white p5hmage w3income p5numpla w3momed_hsb
     &lt;int&gt;      &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;       &lt;dbl&gt;
1        0      0.556    37.6   54889.     1.13       0.464
2        1      0.725    39.6   82074.     1.09       0.227</code></pre>
</div>
</div>
<p>Ao considermos o uso de covariáveis na análise, passamos por um processo em que identificamos na literatura que as covariáveis podem influenciar a relação mensurada pelas variáveis de interesse. Ao não adotar essas covariáveis na análise, podemos tipifica-las como confundidoras. Ao decidir adotar, vamos tipifica-las como variáveis de controle. Quando varremos a literatura, identificamos possíveis covariáveis e decidimos inclui-las na análise, estamos aumentando a validade interna do modelo a ser testado.</p>
<p>Verificamos de forma exploratória, que há diferenças de médias das covariáveis com a variável de tratamento. Vamos verificar se estas diferenças são significativas:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(ecls_cov, <span class="cf">function</span>(v) {</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">t.test</span>(ecls[, v] <span class="sc">~</span> ecls[, <span class="st">'catholic'</span>])</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]

    Welch Two Sample t-test

data:  ecls[, v] by ecls[, "catholic"]
t = -13.453, df = 2143.3, p-value &lt; 2.2e-16
alternative hypothesis: true difference in means between group 0 and group 1 is not equal to 0
95 percent confidence interval:
 -0.1936817 -0.1444003
sample estimates:
mean in group 0 mean in group 1 
      0.5561246       0.7251656 


[[2]]

    Welch Two Sample t-test

data:  ecls[, v] by ecls[, "catholic"]
t = -12.665, df = 2186.9, p-value &lt; 2.2e-16
alternative hypothesis: true difference in means between group 0 and group 1 is not equal to 0
95 percent confidence interval:
 -2.326071 -1.702317
sample estimates:
mean in group 0 mean in group 1 
       37.56097        39.57516 


[[3]]

    Welch Two Sample t-test

data:  ecls[, v] by ecls[, "catholic"]
t = -20.25, df = 1825.1, p-value &lt; 2.2e-16
alternative hypothesis: true difference in means between group 0 and group 1 is not equal to 0
95 percent confidence interval:
 -29818.10 -24552.18
sample estimates:
mean in group 0 mean in group 1 
       54889.16        82074.30 


[[4]]

    Welch Two Sample t-test

data:  ecls[, v] by ecls[, "catholic"]
t = 4.2458, df = 2233.7, p-value = 2.267e-05
alternative hypothesis: true difference in means between group 0 and group 1 is not equal to 0
95 percent confidence interval:
 0.02150833 0.05842896
sample estimates:
mean in group 0 mean in group 1 
       1.132669        1.092701 


[[5]]

    Welch Two Sample t-test

data:  ecls[, v] by ecls[, "catholic"]
t = 18.855, df = 2107.3, p-value &lt; 2.2e-16
alternative hypothesis: true difference in means between group 0 and group 1 is not equal to 0
95 percent confidence interval:
 0.2122471 0.2615226
sample estimates:
mean in group 0 mean in group 1 
      0.4640918       0.2272069 </code></pre>
</div>
</div>
<p>Apontamos que todas as candidatas a variável controle indicam diferenças significativas entre os grupos. Portanto, vale a pena incluir todas como variáveis de controle.</p>
</section>
<section id="estimação-dos-propensity-scores" class="level2">
<h2 class="anchored" data-anchor-id="estimação-dos-propensity-scores">Estimação dos propensity scores</h2>
<p>Agora vamos começar o PSM. Decidimos adotar uma técnica de quasi-experimento que busca criar um grupo de controle artificial, agrupando pares de observações, com características muito parecidas, baseadas nas covariáveis. Dessa forma, podemos isolar os efeitos de outras variáveis na relação que queremos mensurar. Em outras palavras, estamos construindo um contrafactual, alterando o design da pesquisa para um mais robusto (com maior validade interna).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>ecls <span class="ot">&lt;-</span> ecls <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">w3income_1k =</span> w3income <span class="sc">/</span> <span class="dv">1000</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>m_ps <span class="ot">&lt;-</span> <span class="fu">glm</span>(catholic <span class="sc">~</span> race_white <span class="sc">+</span> w3income_1k <span class="sc">+</span> p5hmage <span class="sc">+</span> p5numpla <span class="sc">+</span> w3momed_hsb,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">family =</span> <span class="fu">binomial</span>(), <span class="at">data =</span> ecls)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m_ps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = catholic ~ race_white + w3income_1k + p5hmage + 
    p5numpla + w3momed_hsb, family = binomial(), data = ecls)

Coefficients:
              Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept) -3.2125519  0.2379826 -13.499  &lt; 2e-16 ***
race_white   0.3145014  0.0700895   4.487 7.22e-06 ***
w3income_1k  0.0073038  0.0006495  11.245  &lt; 2e-16 ***
p5hmage      0.0292168  0.0050771   5.755 8.69e-09 ***
p5numpla    -0.1439392  0.0912255  -1.578    0.115    
w3momed_hsb -0.6935868  0.0743207  -9.332  &lt; 2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 7701.3  on 9266  degrees of freedom
Residual deviance: 7168.8  on 9261  degrees of freedom
  (1811 observations deleted due to missingness)
AIC: 7180.8

Number of Fisher Scoring iterations: 5</code></pre>
</div>
</div>
<p>Basicamente, rodamos um modelo de regressão logística para calcular os propensity scores (a probabilidade de cada observação de fazer parte de um grupo da variável de tratamento). Com esse passo inicial, observações que são de um grupo, mas tem características comuns a de outro, são classificados com base nas características (covariáveis).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>prs_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">pr_score =</span> <span class="fu">predict</span>(m_ps, <span class="at">type =</span> <span class="st">"response"</span>),</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>                     <span class="at">catholic =</span> m_ps<span class="sc">$</span>model<span class="sc">$</span>catholic)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(prs_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   pr_score catholic
1 0.2292928        0
2 0.1801360        0
4 0.2092957        0
5 0.2154022        1
6 0.3604931        0
7 0.1080608        0</code></pre>
</div>
</div>
</section>
<section id="análise-da-área-de-suporte-comum" class="level2">
<h2 class="anchored" data-anchor-id="análise-da-área-de-suporte-comum">Análise da área de suporte comum</h2>
<p>Vamos verificar o resultado da classificação de scores, utilizando histogramas:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>labs <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"São de escola:"</span>, <span class="fu">c</span>(<span class="st">"Catholic"</span>, <span class="st">"Public"</span>))</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>prs_df <span class="sc">%&gt;%</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">catholic =</span> <span class="fu">ifelse</span>(catholic <span class="sc">==</span> <span class="dv">1</span>, labs[<span class="dv">1</span>], labs[<span class="dv">2</span>])) <span class="sc">%&gt;%</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> pr_score)) <span class="sc">+</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>catholic) <span class="sc">+</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Probabilidade de ser de escola católica"</span>) <span class="sc">+</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Aula09_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Como o grupo de escola católica é menor, é natural que os propensity scores acompanhem o número de observações do grupo menor.</p>
</section>
<section id="executando-o-matching" class="level2">
<h2 class="anchored" data-anchor-id="executando-o-matching">Executando o matching</h2>
<p>Agora podemos parear os dados. Estamos limitados a região de suporte comum, como foi definido anteriormente. O método ou algoritmo adotado aqui, irá procurar pares de observações com propensity scores mais próximos. Na limitação deste método, outros podem ser adotados. Neste momento, também vamos omitir os dados ausentes, pois atrapalham o algoritmo de matching.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>ecls_nomiss <span class="ot">&lt;-</span> ecls <span class="sc">%&gt;%</span>  <span class="co"># MatchIt does not allow missing values</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(c5r2mtsc_std, catholic, <span class="fu">one_of</span>(ecls_cov)) <span class="sc">%&gt;%</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>()</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>mod_match <span class="ot">&lt;-</span> <span class="fu">matchit</span>(catholic <span class="sc">~</span> race_white <span class="sc">+</span> w3income <span class="sc">+</span> p5hmage <span class="sc">+</span> p5numpla <span class="sc">+</span> w3momed_hsb,</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">method =</span> <span class="st">"nearest"</span>, <span class="at">data =</span> ecls_nomiss)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>O modelo foi gerado. Agora, podemos verificar alguns resultados de qualidade do modelo:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>dta_m <span class="ot">&lt;-</span> <span class="fu">match.data</span>(mod_match)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(dta_m)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2704   10</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod_match)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
matchit(formula = catholic ~ race_white + w3income + p5hmage + 
    p5numpla + w3momed_hsb, data = ecls_nomiss, method = "nearest")

Summary of Balance for All Data:
            Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean
distance           0.1927        0.1379          0.6486     1.0007    0.2086
race_white         0.7411        0.5914          0.3418          .    0.1497
w3income       82568.9357    55485.0210          0.5777     1.1373    0.1565
p5hmage           39.5932       37.5658          0.3874     0.6383    0.0408
p5numpla           1.0917        1.1298         -0.1242     0.6132    0.0076
w3momed_hsb        0.2234        0.4609         -0.5703          .    0.2375
            eCDF Max
distance      0.3109
race_white    0.1497
w3income      0.3062
p5hmage       0.1893
p5numpla      0.0277
w3momed_hsb   0.2375

Summary of Balance for Matched Data:
            Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean
distance           0.1927        0.1927          0.0000     1.0000    0.0000
race_white         0.7411        0.7470         -0.0135          .    0.0059
w3income       82568.9357    81403.9926          0.0248     1.0114    0.0059
p5hmage           39.5932       39.5503          0.0082     1.0036    0.0016
p5numpla           1.0917        1.0762          0.0507     1.0627    0.0040
w3momed_hsb        0.2234        0.2152          0.0195          .    0.0081
            eCDF Max Std. Pair Dist.
distance      0.0030          0.0002
race_white    0.0059          0.0811
w3income      0.0118          0.0536
p5hmage       0.0059          0.1416
p5numpla      0.0163          0.1184
w3momed_hsb   0.0081          0.0728

Sample Sizes:
          Control Treated
All          7915    1352
Matched      1352    1352
Unmatched    6563       0
Discarded       0       0</code></pre>
</div>
</div>
<p>Queremos que as diferenças de médias estema próximas de 0, para assim corroborar o bom pareamento, indicando que temos grupos bem parecidos e, consequentemente, controlando as covariáveis. Conseguimos parear 1352 observações de cad grupo (controle e tratamento), sem descartar nenhum dado não ausente do menor grupo (dos que estudam em escola católica).</p>
<p>Se tivermos problemas em gerar o modelo de matching, ou em obter bom ajustamento, podemos tentar outros algoritmos de matching.</p>
<p>Vamos agora verificar a diferença de médias que obtivemos:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>dta_m <span class="sc">%&gt;%</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(catholic) <span class="sc">%&gt;%</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">one_of</span>(ecls_cov)) <span class="sc">%&gt;%</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise_all</span>(<span class="fu">funs</span>(mean))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `catholic`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: `funs()` was deprecated in dplyr 0.8.0.
ℹ Please use a list of either functions or lambdas:

# Simple named list: list(mean = mean, median = median)

# Auto named with `tibble::lst()`: tibble::lst(mean, median)

# Using lambdas list(~ mean(., trim = .2), ~ median(., na.rm = TRUE))</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 6
  catholic race_white p5hmage w3income p5numpla w3momed_hsb
     &lt;int&gt;      &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;       &lt;dbl&gt;
1        0      0.747    39.6   81404.     1.08       0.215
2        1      0.741    39.6   82569.     1.09       0.223</code></pre>
</div>
</div>
<p>Uma confirmação ainda mais precisa que o matching funcionou é rodar testes de comparação de médias, buscando encontrar a não rejeição da hipótese nula.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(ecls_cov, <span class="cf">function</span>(v) {</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">t.test</span>(dta_m[, v] <span class="sc">~</span> dta_m<span class="sc">$</span>catholic)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]

    Welch Two Sample t-test

data:  dta_m[, v] by dta_m$catholic
t = 0.35243, df = 2701.8, p-value = 0.7245
alternative hypothesis: true difference in means between group 0 and group 1 is not equal to 0
95 percent confidence interval:
 -0.02700440  0.03883872
sample estimates:
mean in group 0 mean in group 1 
      0.7470414       0.7411243 


[[2]]

    Welch Two Sample t-test

data:  dta_m[, v] by dta_m$catholic
t = -0.21331, df = 2702, p-value = 0.8311
alternative hypothesis: true difference in means between group 0 and group 1 is not equal to 0
95 percent confidence interval:
 -0.4372485  0.3514496
sample estimates:
mean in group 0 mean in group 1 
        39.5503         39.5932 


[[3]]

    Welch Two Sample t-test

data:  dta_m[, v] by dta_m$catholic
t = -0.64787, df = 2701.9, p-value = 0.5171
alternative hypothesis: true difference in means between group 0 and group 1 is not equal to 0
95 percent confidence interval:
 -4690.731  2360.845
sample estimates:
mean in group 0 mean in group 1 
       81403.99        82568.94 


[[4]]

    Welch Two Sample t-test

data:  dta_m[, v] by dta_m$catholic
t = -1.339, df = 2699.5, p-value = 0.1807
alternative hypothesis: true difference in means between group 0 and group 1 is not equal to 0
95 percent confidence interval:
 -0.038278301  0.007213213
sample estimates:
mean in group 0 mean in group 1 
       1.076183        1.091716 


[[5]]

    Welch Two Sample t-test

data:  dta_m[, v] by dta_m$catholic
t = -0.51108, df = 2701.5, p-value = 0.6093
alternative hypothesis: true difference in means between group 0 and group 1 is not equal to 0
95 percent confidence interval:
 -0.03935185  0.02307966
sample estimates:
mean in group 0 mean in group 1 
      0.2152367       0.2233728 </code></pre>
</div>
</div>
</section>
<section id="efeito-do-tratamento-na-variável-resposta" class="level2">
<h2 class="anchored" data-anchor-id="efeito-do-tratamento-na-variável-resposta">Efeito do tratamento na variável resposta</h2>
<p>Finalmente, vamos nos voltar para as variáveis de interesse e rodar o modelo estatístico novamente, mas dessa vez, nos dados pareados.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">t.test</span>(c5r2mtsc_std <span class="sc">~</span> catholic, <span class="at">data =</span> dta_m)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Welch Two Sample t-test

data:  c5r2mtsc_std by catholic
t = 4.5214, df = 2682.1, p-value = 6.411e-06
alternative hypothesis: true difference in means between group 0 and group 1 is not equal to 0
95 percent confidence interval:
 0.08929508 0.22605937
sample estimates:
mean in group 0 mean in group 1 
      0.3673451       0.2096679 </code></pre>
</div>
</div>
<p>Percebemos que agora a interpretação é o contrário. As notas de matemáticas são melhores na escola pública.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>dta_m <span class="sc">%&gt;%</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(catholic) <span class="sc">%&gt;%</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n_students =</span> <span class="fu">n</span>(),</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">mean_math =</span> <span class="fu">mean</span>(c5r2mtsc_std),</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">std_error =</span> <span class="fu">sd</span>(c5r2mtsc_std)<span class="sc">/</span><span class="fu">sqrt</span>(n_students))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 4
  catholic n_students mean_math std_error
     &lt;int&gt;      &lt;int&gt;     &lt;dbl&gt;     &lt;dbl&gt;
1        0       1352     0.367    0.0257
2        1       1352     0.210    0.0236</code></pre>
</div>
</div>
<p>Quando isolamos as covariáveis (antes confundindo essa relação), obtivemos 16% a mais de desvios padronizados da nota de matemática para o grupo 0 (estudantes de escola pública).</p>
</section>
<section id="alguns-apontamentos" class="level2">
<h2 class="anchored" data-anchor-id="alguns-apontamentos">Alguns apontamentos</h2>
<ul>
<li>Não é sempre que o uso do PSM consegue provocar esta mudança de interpretação das hipóteses, como ocorreu neste exemplo.</li>
<li>No entanto, conseguimos obter uma magnitude mais fidedigna, mais próxima da realidade, e assim podemos tomar decisões melhores.</li>
<li>Neste caso específico, a conclusão seria completamente equivocada, caso não adotassemos o PSM.</li>
<li>O design de pesquisa anterior era inapropriado para avaliar as diferenças no grupo de tratamento, justamente por haver serias ameaças à validade interna.</li>
<li>O PSM não só contornou esta situação, mas fez isso a partir de dados já coletados, sem a necessidade de ir a campo novamente fazer um experimento real (provavelmente seria inviável ou iria demorar muito tempo e seria caro).</li>
</ul>
</section>
<section id="validação-com-subamostra" class="level2">
<h2 class="anchored" data-anchor-id="validação-com-subamostra">Validação com subamostra</h2>
<p>Sabemos que um n grande pode inflar o poder estatístico, levando a decisões erradas em testes de hipóteses. Portanto, para validar os resultados, é importante refazer o teste com as variáveis de interesse a partir de subamostra com n controlado (a partir do cálculo de poder estatístico).</p>
<p>Como temos uma larga amostra, vamos ser conservadores nos parâmetros de cálculo de amostra. Cohen define que para o teste t, temos um efeito pequeno em 0,2, médio em 0,5 e grande 0,8.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span> (pwr)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="co">#Verificando amostra com power = 0,95</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>pwr_result <span class="ot">&lt;-</span> <span class="fu">pwr.t.test</span>(<span class="at">d =</span> <span class="fl">0.2</span>, <span class="at">power =</span> <span class="fl">0.95</span>, <span class="at">sig.level =</span> <span class="fl">0.05</span>, <span class="at">type =</span> <span class="st">"two.sample"</span>)</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>total_sample_size <span class="ot">&lt;-</span> <span class="fu">round</span>(pwr_result<span class="sc">$</span>n)</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>total_sample_size</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 651</code></pre>
</div>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Seleção aleatória proporcional por grupo</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>sub_sample <span class="ot">&lt;-</span> dta_m <span class="sc">%&gt;%</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(catholic) <span class="sc">%&gt;%</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_sample</span>(<span class="at">n =</span> total_sample_size) <span class="sc">%&gt;%</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Agora fazemos o teste novamente com a esperança de obter resultados semelhantes</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">t.test</span>(c5r2mtsc_std <span class="sc">~</span> catholic, <span class="at">data =</span> sub_sample)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Welch Two Sample t-test

data:  c5r2mtsc_std by catholic
t = 4.8048, df = 1295.9, p-value = 1.73e-06
alternative hypothesis: true difference in means between group 0 and group 1 is not equal to 0
95 percent confidence interval:
 0.1428409 0.3399748
sample estimates:
mean in group 0 mean in group 1 
      0.4198846       0.1784767 </code></pre>
</div>
</div>
<p>Obtivemos regra de decisão igual. Portanto, o efeito inflacionado do poder estatístico não altera a conclusão final: Alunos de escolas públicas tem notas substancialmente maiores do que os alunos de escolas católicas.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Configurar número de repetições</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>num_repeticoes <span class="ot">&lt;-</span> <span class="dv">20</span>  <span class="co"># Número de subamostragens</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Armazenar p-valores</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>p_valores <span class="ot">&lt;-</span> <span class="fu">numeric</span>(num_repeticoes)</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop para realizar subamostragens e calcular os p-valores</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>num_repeticoes) {</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Gerar subamostra</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>  sub_sample <span class="ot">&lt;-</span> dta_m <span class="sc">%&gt;%</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(catholic) <span class="sc">%&gt;%</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice_sample</span>(<span class="at">n =</span> total_sample_size) <span class="sc">%&gt;%</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>()</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Realizar teste t com a subamostra</span></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>  teste_t <span class="ot">&lt;-</span> <span class="fu">t.test</span>(c5r2mtsc_std <span class="sc">~</span> catholic, <span class="at">data =</span> sub_sample)</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>  p_valores[i] <span class="ot">&lt;-</span> teste_t<span class="sc">$</span>p.value</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Criar um data frame com os resultados</span></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>resultados <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">Tentativa =</span> <span class="dv">1</span><span class="sc">:</span>num_repeticoes,</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">P_Valor =</span> p_valores</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Criar o gráfico</span></span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(resultados, <span class="fu">aes</span>(<span class="at">x =</span> Tentativa, <span class="at">y =</span> P_Valor)) <span class="sc">+</span></span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"P-Valores entre Subamostras"</span>,</span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Tentativa (Subsample)"</span>,</span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Diferença de P-Valor (em relação ao centro)"</span></span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Aula09_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Caso você tenha muitas subamostras com p &gt; 0,05, um procedimento mais robusto pode ser feito: Ao invés de gerar subamostras da amostra pareada, você pode fazer o pareamento de cada subamostra. Assim, garantimos um melhor balanceamento. Se mesmo na forma mais conservadora de cálculo de amostra, os p-valores da subamostras discordarem, podemos afirmar que a diferença é inconclusiva e portanto, não rejeitamos a hipótese nula.</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>